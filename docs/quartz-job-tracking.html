<!DOCTYPE html>

<html></html><html class="has-navbar-fixed-top"><head><meta charset="utf-8" content="text/html" /><meta content="width=device-width, initial-scale=1" name="viewport" /><link href="https://sneakypeet.github.io/sneakycode.net/quartz-job-tracking" rel="canonnical" /><link href="https://sneakypeet.github.io/sneakycode.net/rss/" rel="alternative" title="SneakyCode" type="application/rss+xml" /><title>Job Tracking using Quartz for .net</title><meta content="Pieter Koornhof" name="author" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" /><link href="https://sneakypeet.github.io/sneakycode.net/android-icon-192x192.png" rel="icon" sizes="192x192" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/manifest.json" rel="manifest" /><meta content="#ffffff" name="msapplication-TileColor" /><meta content="ms-icon-144x144.png" name="msapplication-TileImage" /><meta content="#ffffff" name="theme-color" /><meta content="SneakyCode" property="og:site_name" /><meta content="article" property="og:type" /><meta content="Job Tracking using Quartz for .net" property="og:title" /><meta property="og:description" /><meta content="https://sneakypeet.github.io/sneakycode.net/quartz-job-tracking" property="og:url" /><meta content="csharp" property="article:tag" /><meta content="quartz" property="article:tag" /><link href="https://sneakypeet.github.io/sneakycode.net/style.css" rel="stylesheet" /><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" /></head><body><nav class="navbar is-fixed-top is-dark has-gradient" role="navigation"><div class="navbar-brand"><a class="navbar-item has-text-weight-bold" href="https://sneakypeet.github.io/sneakycode.net/">sneakycode</a></div></nav><nav aria-label="main navigation" class="navbar is-fixed-bottom is-dark has-gradient" role="navigation"><div class="navbar-brand"><a aria-label="home" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/"><span class="icon"><i class="fa fa-lg fa-bath"></i></span></a><a aria-label="history" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/all-posts"><span class="icon"><i class="fa fa-lg fa-history"></i></span></a><a aria-label="tags" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/tags"><span class="icon"><i class="fa fa-lg fa-tags"></i></span></a><a aria-label="rss" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/rss.rss"><span class="icon"><i class="fa fa-lg fa-rss"></i></span></a><a aria-label="github" class="navbar-item" href="https://github.com/sneakypeet" target="_blank"><span class="icon"><i class="fa fa-lg fa-github"></i></span></a><a aria-label="twitter " class="navbar-item" href="https://twitter.com/PieterKoornhof" target="_blank"><span class="icon"><i class="fa fa-lg fa-twitter"></i></span></a></div></nav><div class="section"><div class="container"><div class="columns is-8 is-variable is-desktop"><article class="column is-three-quarters-desktop"><h1 class="title has-text-weight-light">Job Tracking using Quartz for .net</h1><p class="subtitle is-6 post-tags"><span class="tags"><span class="tag is-primary tag-lite">2015-03-04</span><a class="tag" href="https://sneakypeet.github.io/sneakycode.net/tag/csharp">csharp</a><a class="tag" href="https://sneakypeet.github.io/sneakycode.net/tag/quartz">quartz</a></span></p><div class="has-text-justified content"><p>A project that I recently worked on has a worker role that runs about 40 jobs. With some of these jobs running for hours it became imperative that we knew when these jobs were running, if they were currently running, how long they were running, if they were overlapping with other dependent jobs etc.</p><p>Below I will show you how to easily setup Job Tracking using <a href="http://www.quartz-scheduler.net/">quartz-scheduler</a> for .net.</p><p><strong>Listeners</strong></p><p>Quartz.net provides us with the concept of Listeners. Listeners are objects that you create to perform actions based on events occurring within the scheduler. Quartz provides the following three listener interfaces:</p>
<ul>
  <li>ITriggerListener</li>
  <li>IJobListener</li>
  <li>ISchedulerListener</li>
</ul><p>Each of these provides you with methods that get called on various events. More info on these can be found <a href="http://www.quartz-scheduler.net/documentation/quartz-2.x/tutorial/trigger-and-job-listeners.html">here</a> and <a href="http://www.quartz-scheduler.net/documentation/quartz-2.x/tutorial/scheduler-listeners.html">here</a>.</p><p><strong>Setup</strong></p><p>First you need to create the implementation of whatever listener you want.</p>
<pre class="syntax"><code class="csharp"><span></span><span class="k">public</span> <span class="k">class</span> <span class="nc">MyJobListener</span> <span class="p">:</span> <span class="n">IJobListener</span>
</code></pre><p>Then you need to register the listener with your scheduler.</p>
<pre class="syntax"><code class="csharp"><span></span><span class="kt">var</span> <span class="n">scheduler</span> <span class="p">=</span> <span class="n">SchedulerFactory</span><span class="p">.</span><span class="n">GetScheduler</span><span class="p">();</span>
<span class="n">scheduler</span><span class="p">.</span><span class="n">ListenerManager</span><span class="p">.</span><span class="n">AddJobListener</span><span class="p">(</span><span class="n">myInstanceOfJobListener</span><span class="p">);</span>
<span class="n">scheduler</span><span class="p">.</span><span class="n">ListenerManager</span><span class="p">.</span><span class="n">AddSchedulerListener</span><span class="p">(</span><span class="n">myInstanceOfScheduleListener</span><span class="p">);</span>
</code></pre><p>All that is left is to implement the methods for the events you want to hook into. You can register multiple listeners of the same type.</p><p><strong>Implementation</strong></p><p>For my solution I hooked into the following methods On IScheduleListener:</p>
<pre class="syntax"><code class="csharp"><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">JobScheduled</span><span class="p">(</span><span class="n">ITrigger</span> <span class="n">trigger</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">trigger</span><span class="p">.</span><span class="n">JobKey</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="n">DateTime</span><span class="p">?</span> <span class="n">nextStartDate</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">trigger</span><span class="p">.</span><span class="n">GetNextFireTimeUtc</span><span class="p">().</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">nextStartDate</span> <span class="p">=</span> <span class="n">trigger</span><span class="p">.</span><span class="n">GetNextFireTimeUtc</span><span class="p">().</span><span class="n">Value</span><span class="p">.</span><span class="n">DateTime</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//Do something with the information</span>
<span class="p">}</span>
</code></pre><p>This method gets called each time a job is scheduled. I use this so keep track of all the jobs that are scheduled and can easily extract which jobs have never ran. If you need to you can also extract the trigger type. You can then use the trigger type to form some kind of calendar view of when jobs will run.</p><p>On IJobListener:</p>
<pre class="syntax"><code class="csharp"><span></span><span class="k">public</span> <span class="k">void</span> <span class="nf">JobToBeExecuted</span><span class="p">(</span><span class="n">IJobExecutionContext</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">JobDetail</span><span class="p">.</span><span class="n">JobType</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="n">DateTime</span> <span class="n">startTime</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">FireTimeUtc</span><span class="p">.</span><span class="n">HasValue</span> <span class="p">?</span> <span class="n">context</span><span class="p">.</span><span class="n">FireTimeUtc</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">DateTime</span> <span class="p">:</span> <span class="n">DateTime</span><span class="p">.</span><span class="n">UtcNow</span><span class="p">;</span>
    <span class="c1">//do something with info</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">void</span> <span class="nf">JobWasExecuted</span><span class="p">(</span><span class="n">IJobExecutionContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">JobExecutionException</span> <span class="n">jobException</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">name</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">JobDetail</span><span class="p">.</span><span class="n">JobType</span><span class="p">.</span><span class="n">Name</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">runtime</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">JobRunTime</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">jobException</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//do something with error info</span>
    <span class="p">}</span>

    <span class="n">DateTime</span><span class="p">?</span> <span class="n">nextRunDate</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
    <span class="k">if</span><span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">NextFireTimeUtc</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">nextRunDate</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">NextFireTimeUtc</span><span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="n">DateTime</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">//do something with info</span>
<span class="p">}</span>
</code></pre><p>It is apparent that these methods get called just before a job executes and just after it finished. JobWasExecuted will get called even if there was an exception and quartz is nice enough to provide you with the exception object.</p><p>As mentioned we use the data gathered to make sure our worker role is in good health. There are various other methods on these interfaces so have a look at the linked documentation.</p>
<hr /><p><em>This post was first published on <a href="http://blog.entelect.co.za/home">blog.entelect.co.za</a></em></p><p><a href="http://www.codeproject.com/script/Articles/BlogFeedList.aspx?amid=8804440" rel="tag" style="display:none">CodeProject</a></p></div></article><div aria-label="pagination" class="column" role="navigation"><div class="short-timeline"><div class="timeline is-rtl"><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/getting-started-with-chat-ops">Older</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/getting-started-with-chat-ops">Getting Started With Chat Ops</a></div></div><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/modeling-with-aggregates">Newer</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/modeling-with-aggregates">Modeling with Aggregates</a></div></div><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/tag/csharp">csharp</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/signalr-hello-world">SignalR Hello World (That is not a chat app)</a></div></div><div class="timeline-header"><span class="tag is-primary tag-lite">end</span></div></div></div></div></div><div><div id="disqus_thread"></div><script>var disqus_config = function () {
           this.page.url = 'http://sneakycode.net/quartz-job-tracking';
           // this.page.identifier = PAGE_IDENTIFIER;
         };
         (function() { // DON'T EDIT BELOW THIS LINE
           var d = document, s = d.createElement('script');
           s.src = 'https://sneakycode.disqus.com/embed.js';
           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
         })();</script></div></div></div></body></html>