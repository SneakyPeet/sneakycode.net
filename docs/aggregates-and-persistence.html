<!DOCTYPE html>

<html></html><html class="has-navbar-fixed-top"><head><meta charset="utf-8" content="text/html" /><meta content="width=device-width, initial-scale=1" name="viewport" /><link href="https://sneakypeet.github.io/sneakycode.net/aggregates-and-persistence" rel="canonnical" /><link href="https://sneakypeet.github.io/sneakycode.net/rss/" rel="alternative" title="SneakyCode" type="application/rss+xml" /><title>Aggregates and Persistence</title><meta content="Pieter Koornhof" name="author" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-57x57.png" rel="apple-touch-icon" sizes="57x57" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-60x60.png" rel="apple-touch-icon" sizes="60x60" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-72x72.png" rel="apple-touch-icon" sizes="72x72" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-76x76.png" rel="apple-touch-icon" sizes="76x76" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-114x114.png" rel="apple-touch-icon" sizes="114x114" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-120x120.png" rel="apple-touch-icon" sizes="120x120" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-144x144.png" rel="apple-touch-icon" sizes="144x144" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-152x152.png" rel="apple-touch-icon" sizes="152x152" /><link href="https://sneakypeet.github.io/sneakycode.net/apple-icon-180x180.png" rel="apple-touch-icon" sizes="180x180" /><link href="https://sneakypeet.github.io/sneakycode.net/android-icon-192x192.png" rel="icon" sizes="192x192" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/favicon-96x96.png" rel="icon" sizes="96x96" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="https://sneakypeet.github.io/sneakycode.net/manifest.json" rel="manifest" /><meta content="#ffffff" name="msapplication-TileColor" /><meta content="ms-icon-144x144.png" name="msapplication-TileImage" /><meta content="#ffffff" name="theme-color" /><meta content="SneakyCode" property="og:site_name" /><meta content="article" property="og:type" /><meta content="Aggregates and Persistence" property="og:title" /><meta property="og:description" /><meta content="https://sneakypeet.github.io/sneakycode.net/aggregates-and-persistence" property="og:url" /><meta content="domain driven design" property="article:tag" /><meta content="ddd" property="article:tag" /><meta content="testing" property="article:tag" /><meta content="aggregates" property="article:tag" /><link href="https://sneakypeet.github.io/sneakycode.net/style.css" rel="stylesheet" /><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" /></head><body><nav class="navbar is-fixed-top is-dark has-gradient" role="navigation"><div class="navbar-brand"><a class="navbar-item has-text-weight-bold" href="https://sneakypeet.github.io/sneakycode.net/">sneakycode</a></div></nav><nav aria-label="main navigation" class="navbar is-fixed-bottom is-dark has-gradient" role="navigation"><div class="navbar-brand"><a aria-label="home" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/"><span class="icon"><i class="fa fa-lg fa-bath"></i></span></a><a aria-label="history" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/all-posts"><span class="icon"><i class="fa fa-lg fa-history"></i></span></a><a aria-label="tags" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/tags"><span class="icon"><i class="fa fa-lg fa-tags"></i></span></a><a aria-label="rss" class="navbar-item" href="https://sneakypeet.github.io/sneakycode.net/rss.rss"><span class="icon"><i class="fa fa-lg fa-rss"></i></span></a><a aria-label="github" class="navbar-item" href="https://github.com/sneakypeet" target="_blank"><span class="icon"><i class="fa fa-lg fa-github"></i></span></a><a aria-label="twitter " class="navbar-item" href="https://twitter.com/PieterKoornhof" target="_blank"><span class="icon"><i class="fa fa-lg fa-twitter"></i></span></a></div></nav><div class="section"><div class="container"><div class="columns is-8 is-variable is-desktop"><article class="column is-three-quarters-desktop"><h1 class="title has-text-weight-light">Aggregates and Persistence</h1><p class="subtitle is-6 post-tags"><span class="tags"><span class="tag is-primary tag-lite">2015-04-01</span><a class="tag" href="https://sneakypeet.github.io/sneakycode.net/tag/aggregates">aggregates</a><a class="tag" href="https://sneakypeet.github.io/sneakycode.net/tag/ddd">ddd</a><a class="tag" href="https://sneakypeet.github.io/sneakycode.net/tag/domain-driven-design">domain driven design</a><a class="tag" href="https://sneakypeet.github.io/sneakycode.net/tag/testing">testing</a></span></p><div class="has-text-justified content"><p>In a previous post I gave an overview of <a href="http://sneakycode.net/modeling-with-aggregates/">aggregates</a>. In that post I said that aggregates are self-contained units that we work with to avoid messing up our code. Aggregates help us build a rich domain. This is a domain that knows about itself. When you want to know something, you ask the domain. When you want something done, you ask the domain. For the domain to be able to answer your questions and perform your tasks, it needs all the information. To do this we construct our aggregates with all the data that they need. Ideally we would like our control flow to look something like this:</p>
<pre class="syntax"><code class="csharp"><span></span><span class="n">apiLayer</span><span class="p">.</span><span class="n">DoSomeWork</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">domain</span> <span class="p">=</span> <span class="n">dataLayer</span><span class="p">.</span><span class="n">getData</span><span class="p">()</span>
  <span class="n">domain</span><span class="p">.</span><span class="n">doTheWork</span><span class="p">()</span>
  <span class="n">dataLayer</span><span class="p">.</span><span class="n">saveData</span><span class="p">()</span>
<span class="p">}</span>
</code></pre><p>To achieve this we need to limit our trips to the persistence layer. This means we load all the data that we need upfront, and then construct our aggregate. To take it one step further we can ask our persistence layer to provide us with our constructed aggregate. This is where dependence on the domain become apparent. For the persistence layer to provide us with a domain object, it needs to know about the domain. When thinking about layered architecture we are used to the persistence layer being at the center of the onion. But moving the domain into the center means that we can model our domain without ever caring about persistence. This reduces dependencies in the domain considerably, meaning that our domain is void of program flow clutter, clearly defined and very testable. The problem we need to solve becomes the focus of our application.</p><p>Domain Driven Design typically uses the repository pattern. Our repositories are responsible to abstract the persistence details away from our domain. All that the domain will know is that it can get data in the form of aggregates and persist data in the form of aggregates. To do this we do two things</p>
<ul>
  <li>We declare the interface for our repositories in the domain layer. This might seem counter intuitive, but having our interface live in the domain layer means that we completely decouple our persistence from our app. Thus if we are forced to change the persistence implementation, the only code we need to write is our new implementation and update our dependency injection. Our application layer will be ignorant of this change (except for DI code) because as far as it is concerned it uses the contracts defined in the domain. Well how often do we actually change out our persistence? Not that often, but the principle extends beyond just persistence. We use it for other infrastructure code as well. I currently have colleagues who need to change from LINQ to SQL to EntityFramework, and if they had this in place the change would have been a lot less hectic</li>
  <li>The second thing we do is return Aggregates (and not entities) from our persistence layer. This is to force us to load all we need to answer the questions we have. This does mean that the mapping from our persistence to our domain will be more complex, but moving this code out of our application and domain layers means that intent becomes clear and that we are moving toward single responsibility. Domain handles rules, Application handles flow and Persistence handles data mapping.</li>
</ul><p>The above concepts might be weird at first and it is something that needs to be wrestled with and tried before the usefulness can be experienced. It is also not always straight forward to implement the persistence layer, but the gains are worth it.</p><p>The next big question to ask is whether to use generic repos or not, but this is a topic for another post.</p><p><a href="http://www.codeproject.com/script/Articles/BlogFeedList.aspx?amid=8804440" rel="tag" style="display:none">CodeProject</a></p></div></article><div aria-label="pagination" class="column" role="navigation"><div class="short-timeline"><div class="timeline is-rtl"><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/getting-wooed-by-fsharp">Older</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/getting-wooed-by-fsharp">Getting wooed by F#</a></div></div><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/anemia-induced-memory-loss">Newer</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/anemia-induced-memory-loss">Anemia induced memory loss</a></div></div><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/tag/ddd">ddd</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/what-language-does-your-application-speak">What Language Does Your Application Speak</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/reflecting-on-domain-driven-design">Reflecting on Domain Driven Design</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/anemia-induced-memory-loss">Anemia induced memory loss</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/getting-wooed-by-fsharp">Getting wooed by F#</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/modeling-with-aggregates">Modeling with Aggregates</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/make-those-value-objects-work-for-you">Make Those Value Objects Work For You</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/value-objects">Value Objects</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/domain-driven-design-app-structure-part-2">Domain Driven Design App Structure part 2</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/domain-driven-design-app-structure">Domain Driven Design App Structure</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/intro-to-practical-domain-driven-design">Introduction To Practical Domain Driven Design</a></div></div><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/tag/testing">testing</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/better-test-documentation">Better Test Documentation</a></div></div><div class="timeline-header"><a class="tag is-primary tag-lite" href="https://sneakypeet.github.io/sneakycode.net/tag/aggregates">aggregates</a></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/anemia-induced-memory-loss">Anemia induced memory loss</a></div></div><div class="timeline-item"><div class="timeline-marker"></div><div class="timeline-content"><a class="header" href="https://sneakypeet.github.io/sneakycode.net/modeling-with-aggregates">Modeling with Aggregates</a></div></div><div class="timeline-header"><span class="tag is-primary tag-lite">end</span></div></div></div></div></div><div><div id="disqus_thread"></div><script>var disqus_config = function () {
           this.page.url = 'http://sneakycode.net/aggregates-and-persistence';
           // this.page.identifier = PAGE_IDENTIFIER;
         };
         (function() { // DON'T EDIT BELOW THIS LINE
           var d = document, s = d.createElement('script');
           s.src = 'https://sneakycode.disqus.com/embed.js';
           s.setAttribute('data-timestamp', +new Date());
           (d.head || d.body).appendChild(s);
         })();</script></div></div></div></body></html>